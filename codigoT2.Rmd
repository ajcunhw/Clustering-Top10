---
title: "Trabalho 2 - ME921"
author: "Ana Julia Cunha e Silva"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, error = F)
```

```{r bibliotecas}
library(readxl)
library(tidyverse)
library(covRobust)
library(mclust)

#para comparacao de metodos(comparar com kmeans)
library(factoextra)
library(cluster)
```

```{r carregando o banco e tratando}
dados <- read_xlsx("dados/all-weeks-globalNETFLIX.xlsx")
dados$category <- factor(dados$category)
dados$weekly_rank <- factor(dados$weekly_rank)
dados$cumulative_weeks_in_top_10 <- factor(dados$cumulative_weeks_in_top_10)

dados1 <- dados %>%
  select(!c(episode_launch_details,
            is_staggered_launch, season_title)) %>%
  drop_na() %>% 
  mutate(TituloQtd = log(str_width(show_title)),
         runtime = log(runtime)) %>% group_by(show_title) %>% 
  filter(weekly_views == max(weekly_views)) %>%
  ungroup()

```
log no runtime e no titulo, mais raiz quadrada no weekly_views.

## Analisando com os outliers
```{r estudo do banco}
dados1 %>%
  mutate(weekly_views = sqrt(weekly_views)) %>% 
  select(weekly_views, runtime, TituloQtd) -> dados1
dados1$runtime <- ifelse(dados1$runtime == -Inf, 0, dados1$runtime)
pairs(dados1)

fitBIC <- mclustBIC(dados1)
plot(fitBIC)
fitBIC
fitICL <- mclustICL(dados1)
plot(fitICL)
fitICL
```

```{r modelagem com outlier}
model1 <- Mclust(dados1, 4, modelNames = 'EVI')
plot(model1)
0
summary(model1)
uncerPlot(model1$z)
```

## Analise lidando com os outliers

```{r estudo de perfil}
dados1 %>% mutate(Cluster = factor(model1$classification,
labels = c("Outliers", "C2", "C1", "C3"))) %>%
#mutate(Cluster = reorder(Cluster#, Top10, mean
#                         )) %>%
pivot_longer(-Cluster, names_to = "Attribute",
values_to = "Values") %>%
ggplot(aes(x = Attribute, y = Values, fill = Cluster)) +
geom_boxplot() + theme_classic() + coord_flip() +
theme(legend.position = "bottom")+
  facet_wrap(~Attribute, scale = 'free')

```

ISSO AQUI é PRA TIRAR RUIDO (DA PRA COMPARAR BIC COM E SEM RESIDUO, DEPOIS OS MODELOS RECOMENDADOS)
```{r tratamento de outlier}
nnve.out <- cov.nnve(dados1)

#BIC
fitBIC1 <-  mclustBIC(dados1, initialization = list(noise = (nnve.out$classification == 0)))
   # UniBIC <- mclustBIC(Uni, initialization = list(noise = (nnve.out$classification == 0)))

plot(fitBIC1)
plot(fitBIC)

model <- Mclust(dados1,
                initialization = list(noise = (nnve.out$classification==0)))
summary(model)

```


AINDA NAO ENTENDI O Q ROLA AQUI
```{r}
model2 <- Mclust(dados1, G = 4, prior = priorControl(modelNames = "EVI", 
                                                 shrinkage = 0))
plot(model2)
0
summary(model2)
uncerPlot(model2$z)
```

## kmeans

```{r}
set.seed(236038)
fviz_nbclust(dados1, kmeans, method = "wss")+
  labs(title = "", x = "Número de Clusters",
       y = "Soma dos Quadrados Totais dos Clusters")

set.seed(236038)
fviz_nbclust(dados1, kmeans, method = "silhouette")+
  labs(title="", x = "Número de Clusters",
       y = "Largura Média da Silhueta")

set.seed(236038)
fviz_cluster(modelo0, data = dados1)+theme_classic()+
  labs(title = "")
```

